---

# Deployment step performs the remote deployment to our central hosting instance

kind: pipeline
type: docker
name: deploy

trigger:
  branches:
  - deployment-test
  event:
    include:
    - promote
    - rollback
    - push
    - custom

clone:
  disable: true

steps:
  # Ensure the repo exists
  - name: clone
    image: appleboy/drone-ssh
    settings:
      host:
        - 212.71.250.173
      username: cameron
      key:
        from_secret: ssh_key
      script_stop: false
      script: |
        cd ~/repos
        if [ ! -d "${DRONE_REPO_NAME}" ]; then
          git clone http://cam:"p2Q=Z)uqWKN%t:F"@git.arg.tech/Projects/${DRONE_REPO_NAME}
        fi
  
  # Remove services if they are running
  - name: down
    image: appleboy/drone-ssh
    settings:
      host:
        - 212.71.250.173
      username: cameron
      key:
        from_secret: ssh_key
      script_stop: false
      script: |
        cd ~/repos/${DRONE_REPO_NAME}
        docker compose down

  # Pull new changes from remote
  - name: pull
    image: appleboy/drone-ssh
    settings:
      host:
        - 212.71.250.173
      username: cameron
      key:
        from_secret: ssh_key
      script_stop: false
      script: |
        cd ~/repos/${DRONE_REPO_NAME}
        git pull

  - name: create-secrets
    image: appleboy/drone-ssh
    environment:
      SECRETS:
        from_secret: secrets_production
    settings:
      host:
        - 212.71.250.173
      username: cameron
      key:
        from_secret: ssh_key
      envs:
        - SECRETS
      script_stop: false
      script: |
        cd ~/repos/${DRONE_REPO_NAME}
        
        [[ -z "$SECRETS" ]] && { echo "No secrets specified, skipping step" ; exit 0; }

        mkdir -p .secrets && cd "$_"

        i=1
        while secret=$(echo "$SECRETS" | cut -d "&" -f $i) ; [ -n "$secret" ] ;do
            i=$((i+1))

            key=$(echo "$secret" | cut -d "=" -f 1)
            value=$(echo "$secret" | cut -d "=" -f 2)

            echo "$value" > "$key"
        done

  # Deploy the services from commit
  - name: up
    image: appleboy/drone-ssh
    settings:
      host:
        - 212.71.250.173
      username: cameron
      key:
        from_secret: ssh_key
      script_stop: false
      script: |
        cd ~/repos/${DRONE_REPO_NAME}
        git reset --hard ${DRONE_COMMIT}
        git clean -df
        docker compose up -d

---

kind: secret
name: ssh_key
get:
  path: kv/data/ssh/key
  name: deploy
